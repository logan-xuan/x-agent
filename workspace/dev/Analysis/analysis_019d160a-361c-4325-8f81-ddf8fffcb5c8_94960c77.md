<!-- {"trace_id": "019d160a-361c-4325-8f81-ddf8fffcb5c8", "focus_areas": ["performance", "error"], "cached_at": "2026-02-19T17:36:30.888405", "insights_count": 5, "suggestions_count": 5, "insights": [{"type": "performance", "title": "LLM调用严重超时", "description": "单次LLM调用耗时高达71.7秒，远超正常范围，严重影响系统响应时间", "location": "src.services.llm.router", "severity": "high"}, {"type": "error", "title": "ONNX Runtime缺失导致性能降级", "description": "系统无法使用高性能ONNX嵌入器，被迫使用mock实现，影响向量化性能", "location": "src.memory.embedder", "severity": "medium"}, {"type": "performance", "title": "大量重复API请求", "description": "日志显示大量对阿里云DashScope的POST请求，可能存在重试或缓存问题", "location": "httpx, openai._base_client", "severity": "high"}, {"type": "error", "title": "数据统计异常", "description": "Trace显示总耗时0ms，但实际LLM调用累计耗时超过88秒，监控数据不准确", "location": "tracing system", "severity": "medium"}, {"type": "llm_usage", "title": "Token使用效率不高", "description": "多次调用中token数量较大(8000+ tokens)，可能包含冗余上下文", "location": "src.services.llm.router", "severity": "medium"}], "suggestions": ["安装并配置ONNX Runtime以启用高性能嵌入器，提升向量化处理速度", "检查并优化LLM调用策略，减少不必要的大token请求，实现智能上下文截断", "调查API请求失败原因，优化重试机制和连接池配置，减少无效重试", "修复监控系统的计时逻辑，确保能够准确跟踪端到端请求耗时", "实施请求缓存机制，避免对相同或相似请求重复调用外部API"]} -->

```
┌─────────────────────────────────────────────────────────────┐
│                    调用链路图                                │
└─────────────────────────────────────────────────────────────┘

    🧠 embedder
    │
    ▼
    📍 httpx
    │
    ▼
    📍 _base_client
    │
    ▼
    🌐 websocket
    │
    ▼
    📍 engine
    │
    ▼
    📍 policy_parser
    │
    ▼
    📍 policy_engine
    │
    ▼
    🧠 context_builder
    │
    ▼
    🧠 context_loader
    │
    ▼
    🧠 md_sync
    │
    ▼
    🧠 spirit_loader
    │
    ▼
    🧠 hybrid_search
    │
    ▼
    📍 manager
    │
    ▼
    ✨ router
    │
    ▼
    📍 compressor
    │
    ▼
    📍 react_loop
    │
    ▼
    📍 manager
    │
    ▼
    📍 file_ops
    │
    ▼
    📍 terminal
    │
    ▼
    🧠 smart_memory
    │
    ▼
    ✨ llm [17:32:53]

    ┌─────────────────────────────┐
    │      LLM 调用详情           │
    └─────────────────────────────┘
    │  📨 qwen3-coder-plus
    │     ⏱️  2633ms | 🔢 3608 tokens
    │  📨 qwen3-coder-plus
    │     ⏱️  4514ms | 🔢 8036 tokens
    │  📨 qwen3-coder-plus
    │     ⏱️  71706ms | 🔢 8576 tokens
    │  ... 还有 4 次调用

    ┌─────────────────────────────┐
    │  总耗时: 0ms
    │  节点数: 21
    │  LLM调用: 7次
    └─────────────────────────────┘
```

# 系统性能与错误分析报告

## 概述
根据提供的Trace数据分析，系统存在明显的性能瓶颈和配置问题。总耗时显示为0ms，但实际LLM调用累计耗时超过88秒，存在数据统计不一致的问题。

## 主要问题

### 性能问题
- **严重超时**: 单次LLM调用最高达到71.7秒，严重影响用户体验
- **重复API调用**: 大量对阿里云DashScope的HTTP请求，可能存在重试机制过度触发
- **Mock嵌入器使用**: 由于ONNX Runtime未安装，使用了模拟嵌入器，性能和准确性都受影响

### 错误配置
- **依赖缺失**: ONNX Runtime未正确安装，导致无法使用高性能嵌入器
- **重试机制**: 存在大量的请求重试，表明网络连接或API服务不稳定

## 影响评估
这些问题可能导致系统响应缓慢、资源浪费和用户体验下降。