# Feature Specification: Agent 核心主引导流程

**Feature Branch**: `001-agent-guidance`  
**Created**: 2026-02-15  
**Status**: Draft  
**Input**: User description: "设计agent最核心的主引导流程，workspace/AGENTS.md 行为规范总指导流程文件，包含其他文件使用指南。参考agent-prompt.md，后续每次用户提问都会重载这份文件信息指导后续的agent的执行流程"

---

## 1. 概述

### 1.1 功能目标
为 AI Agent 建立一套完整的主引导流程规范，通过 `workspace/AGENTS.md` 文件作为核心入口，定义 Agent 的行为准则、工作流程和上下文管理策略。每次用户提问时，系统自动重载该文件以指导后续执行流程。

### 1.2 核心文件体系
- **AGENTS.md**: 主引导文件，包含行为规范总指导流程
- **SPIRIT.md**: Agent 身份定义文件
- **OWNER.md**: 用户信息定义文件
- **MEMORY.md**: 长期记忆文件（仅在主会话中加载）
- **TOOLS.md**: 工具使用指南和本地配置
- **BOOTSTRAP.md**: 首次启动引导文件（一次性使用）
- **memory/YYYY-MM-DD.md**: 每日笔记文件

---

## 2. 用户场景与测试 *(mandatory)*

### 2.1 用户场景 1 - 首次启动引导 (Priority: P1)

当 Agent 首次在 workspace 中启动时，需要完成初始化流程，建立工作上下文。

**为什么优先**: 这是 Agent 正常工作的基础，没有正确的初始化，后续所有功能都无法正常执行。

**独立测试**: 可以在全新的 workspace 目录中测试，验证 Agent 是否能正确识别并遵循 BOOTSTRAP.md 的指引完成初始化。

**验收场景**:

1. **Given** 全新的 workspace 目录包含 BOOTSTRAP.md, **When** Agent 首次启动, **Then** Agent 读取 BOOTSTRAP.md 并执行初始化指引
2. **Given** Agent 完成初始化, **When** 确认身份和工具配置, **Then** Agent 删除 BOOTSTRAP.md 并记录初始化完成

---

### 2.2 用户场景 2 - 每次会话启动流程 (Priority: P1)

每次会话开始时，Agent 自动执行标准的信息加载流程，确保上下文连续性。

**为什么优先**: 保证 Agent 在每次对话中都能基于正确的上下文进行响应，是提供一致用户体验的关键。

**独立测试**: 可以在已有完整文件体系的 workspace 中测试，验证 Agent 是否按正确顺序加载所有必需文件。

**验收场景**:

1. **Given** 完整的 workspace 文件体系, **When** 新会话开始, **Then** Agent 按顺序读取 SPIRIT.md → OWNER.md → 今日/昨日 memory 文件
2. **Given** 处于主会话中, **When** 加载上下文, **Then** Agent 额外加载 MEMORY.md 长期记忆文件
3. **Given** 处于共享上下文（如群聊）, **When** 加载上下文, **Then** Agent 不加载 MEMORY.md 以保护隐私

---

### 2.3 用户场景 3 - 用户提问时的流程重载 (Priority: P1)

每次用户提问时，Agent 重载 AGENTS.md 以获取最新的行为指导。

**为什么优先**: 确保 Agent 始终遵循最新的行为规范，支持动态更新指导流程而无需重启。

**独立测试**: 可以修改 AGENTS.md 后立即提问，验证 Agent 是否使用了更新后的指导。

**验收场景**:

1. **Given** 用户发送新的提问, **When** Agent 开始处理, **Then** 自动重载 AGENTS.md 获取最新指导
2. **Given** AGENTS.md 内容已更新, **When** 用户下次提问, **Then** Agent 使用更新后的流程指导执行

---

### 2.4 用户场景 4 - 记忆维护与更新 (Priority: P2)

Agent 定期执行记忆维护，将每日笔记中的重要内容提炼到长期记忆。

**为什么优先**: 支持 Agent 的持续学习和经验积累，提升长期服务质量。

**独立测试**: 可以创建测试用的 memory 文件，验证 Agent 是否能正确识别重要内容并更新 MEMORY.md。

**验收场景**:

1. **Given** 存在多日的 memory 文件, **When** 执行记忆维护任务, **Then** Agent 识别重要事件、经验和洞察
2. **Given** 识别出值得保留的内容, **When** 更新 MEMORY.md, **Then** 提炼后的内容被正确记录，过时信息被清理

---

### 2.5 边缘情况

1. **文件缺失处理**: 当 SPIRIT.md、OWNER.md 等核心文件不存在时，Agent 使用内置默认模板自动创建缺失文件并继续执行（优雅降级策略）
2. **文件损坏处理**: 当 AGENTS.md 格式错误或内容不完整时，Agent 的降级策略是什么？
3. **并发访问**: 当多个会话同时尝试更新 MEMORY.md 时，如何避免冲突？
4. **隐私边界**: 如何确保 MEMORY.md 中的敏感信息不会在共享上下文中泄露？

---

## 3. 需求 *(mandatory)*

### 3.1 功能需求

- **FR-001**: Agent 必须在每次会话开始时自动加载 AGENTS.md，无需用户请求
- **FR-002**: Agent 必须按固定顺序加载上下文文件：SPIRIT.md → OWNER.md → memory/YYYY-MM-DD.md（今日+昨日）
- **FR-003**: 在主会话中，Agent 必须额外加载 MEMORY.md；在共享上下文中禁止加载
- **FR-004**: 每次用户提问时，Agent 必须重载 AGENTS.md 以获取最新指导
- **FR-005**: Agent 必须支持首次启动流程：读取 BOOTSTRAP.md → 执行初始化 → 删除文件
- **FR-006**: Agent 必须定期执行记忆维护，将每日笔记提炼到 MEMORY.md（通过定时任务自动触发）
- **FR-007**: Agent 必须遵守安全准则：不泄露私有数据、不执行未确认的破坏性命令
- **FR-008**: Agent 必须区分外部操作（需询问）和内部操作（可自由执行）

### 3.2 关键实体

- **AGENTS.md**: 主引导文件，包含行为规范、工作流程、安全准则
- **SPIRIT.md**: Agent 身份定义，包含角色定位、性格特征、能力边界
- **OWNER.md**: 用户信息，包含用户偏好、工作习惯、重要背景
- **MEMORY.md**: 长期记忆，包含重要事件、经验教训、提炼洞察
- **TOOLS.md**: 工具配置，包含技能模块使用指南、本地配置信息
- **BOOTSTRAP.md**: 一次性引导文件，包含首次启动指引
- **memory/YYYY-MM-DD.md**: 每日笔记，记录当日原始日志

---

## 4. 成功标准 *(mandatory)*

### 4.1 可衡量成果

- **SC-001**: Agent 在 100% 的会话中正确加载所有必需的上下文文件
- **SC-002**: 上下文加载顺序符合规范，无遗漏或错位
- **SC-003**: MEMORY.md 仅在主会话中加载，在共享上下文中 0 次泄露
- **SC-004**: AGENTS.md 更新后，Agent 在下次提问时 100% 使用新版本，且重载延迟 < 1000ms
- **SC-005**: 首次启动流程在 5 分钟内完成初始化
- **SC-006**: 记忆维护任务每 3-7 天执行一次，MEMORY.md 保持最新

---

## 5. 澄清记录

### Session 2026-02-15

- **Q1**: "主会话"与"共享上下文"的判定标准 → **A**: 基于交互模式检测自动推断（单用户对话 = 主会话，群聊/Discord/多用户 = 共享上下文）
- **Q2**: 核心文件缺失时的处理策略 → **A**: 优雅降级并使用内置默认模板自动创建缺失文件
- **Q3**: AGENTS.md 重载的性能要求 → **A**: < 1000ms
- **Q4**: 记忆维护的触发机制 → **A**: 定时自动触发（系统按固定间隔检查并执行）
- **Q5**: 文件格式规范要求 → **A**: 标准 Markdown + 约定式结构（通过示例文档引导，不强制 schema）

---

## 6. 假设与依赖

### 6.1 假设

- workspace 目录结构遵循标准约定
- 用户有权访问和修改 workspace 中的文件
- 文件系统支持标准的读写操作
- 所有上下文文件采用标准 Markdown 格式，结构通过示例文档约定

### 6.2 依赖

- 文件系统访问权限
- 文件变更检测机制（用于实时重载）
- 交互模式检测能力（区分单用户对话与多用户共享上下文）

---

## 6. 附录

### 7.1 AGENTS.md 内容结构建议

```markdown
# AGENTS.md - 你的工作空间

## 首次启动
[首次启动指引]

## 每次会话开始时
1. 阅读 SPIRIT.md
2. 阅读 OWNER.md
3. 阅读 memory/YYYY-MM-DD.md
4. 主会话中额外阅读 MEMORY.md

## 记忆系统
- 每日笔记记录
- 长期记忆维护

## 安全准则
- 数据保护
- 操作确认

## 外部操作 vs 内部操作
- 可自由执行的操作列表
- 需先询问的操作列表
```

### 7.2 参考文档

- `arch/agent-prompt.md`: Agent 上下文引导文件参考模板
