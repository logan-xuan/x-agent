# Research: Agent 核心主引导流程

**Feature**: Agent 核心主引导流程  
**Date**: 2026-02-15  
**Researcher**: AI Assistant

---

## 1. 技术选型决策

### 1.1 文件监控方案

**决策**: 使用 `watchdog` (Python) 进行文件系统监控

**理由**:
- Python 原生支持，与后端技术栈一致
- 跨平台支持 (Linux/macOS/Windows)
- 支持递归目录监控和文件变更事件
- 异步事件处理，不阻塞主线程

**替代方案考虑**:
- `chokidar` (Node.js): 需要额外 Node 依赖，增加复杂度
- 轮询方案: 性能较差，不符合 < 1000ms 响应要求
- 操作系统原生 API: 跨平台实现复杂

### 1.2 定时任务方案

**决策**: 使用 `APScheduler` (Python) 执行记忆维护任务

**理由**:
- 支持多种触发器（间隔、定时、Cron）
- 支持任务持久化和恢复
- 与 Python 异步框架兼容
- 内存占用低，适合个人级应用

**替代方案考虑**:
- `node-cron`: 需要 Node 运行时
- 系统 Cron: 部署复杂，跨平台困难
- 自定义线程: 可靠性差，需处理异常和恢复

### 1.3 Markdown 解析方案

**决策**: 使用标准库 + 简单正则，不引入复杂解析器

**理由**:
- 需求为读取原始内容注入 LLM，非渲染展示
- 避免过度解析，保持内容原貌
- 减少依赖，符合 YAGNI 原则
- 性能更好，文件读取即可使用

**替代方案考虑**:
- `markdown-it` / `mistune`: 功能过剩，增加依赖
- 自定义解析器: 维护成本高

---

## 2. 关键设计模式

### 2.1 上下文加载器模式 (Context Loader Pattern)

```
┌─────────────────────────────────────────────────────────────┐
│                    ContextLoader                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ AGENTS.md    │  │ SPIRIT.md    │  │ OWNER.md     │      │
│  │   Loader     │  │   Loader     │  │   Loader     │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
│         │                 │                 │              │
│         └─────────────────┼─────────────────┘              │
│                           ▼                                │
│                    ┌─────────────┐                         │
│                    │  Context    │                         │
│                    │  Builder    │                         │
│                    └──────┬──────┘                         │
│                           ▼                                │
│                    ┌─────────────┐                         │
│                    │   Agent     │                         │
│                    │   Context   │                         │
│                    └─────────────┘                         │
└─────────────────────────────────────────────────────────────┘
```

**说明**: 每个文件类型有独立加载器，通过 Context Builder 组合成完整上下文

### 2.2 会话类型检测策略

```
用户输入
    │
    ▼
┌─────────────────┐
│ SessionDetector │
│                 │
│  ┌───────────┐  │
│  │  Channel  │  │ ──► 群聊/Discord ──► 共享上下文
│  │  Type     │  │
│  └───────────┘  │
│                 │
│  ┌───────────┐  │
│  │  User     │  │ ──► 单用户 ──► 主会话
│  │  Count    │  │
│  └───────────┘  │
│                 │
└─────────────────┘
```

**说明**: 基于交互元数据自动推断会话类型，无需用户显式配置

### 2.3 文件重载策略

```
用户提问
    │
    ▼
┌──────────────────────────────────┐
│ 1. 检查 AGENTS.md 修改时间        │
│    (与缓存对比)                   │
├──────────────────────────────────┤
│ 2. 如有更新，重新加载文件         │
│    (异步 I/O)                    │
├──────────────────────────────────┤
│ 3. 解析并更新上下文               │
│    (< 1000ms)                    │
├──────────────────────────────────┤
│ 4. 使用新上下文处理请求           │
└──────────────────────────────────┘
```

---

## 3. 性能优化策略

### 3.1 文件读取优化

- **异步 I/O**: 所有文件操作使用 `aiofiles` 异步执行
- **缓存机制**: 缓存文件内容和修改时间，避免重复读取
- **增量加载**: 仅读取变更文件，未变更文件使用缓存
- **超时控制**: 单文件读取超时 500ms，防止阻塞

### 3.2 内存管理

- **上下文大小限制**: 总上下文大小限制在 100KB 以内
- **历史文件清理**: 仅加载今日和昨日 memory 文件
- **懒加载**: MEMORY.md 仅在主会话中按需加载

### 3.3 并发安全

- **文件锁**: 使用 `filelock` 库防止并发写入冲突
- **原子操作**: 文件写入使用临时文件 + 重命名策略
- **读写分离**: 读取操作不阻塞写入，反之亦然

---

## 4. 错误处理策略

### 4.1 文件缺失处理 (优雅降级)

```python
if not file_exists("SPIRIT.md"):
    # 1. 使用内置默认模板
    content = load_default_template("SPIRIT.md")
    # 2. 自动创建文件
    write_file("SPIRIT.md", content)
    # 3. 记录日志并提示用户
    log.info("已自动创建 SPIRIT.md，请根据需要进行修改")
```

### 4.2 文件损坏处理

```python
try:
    content = read_file("AGENTS.md")
except (UnicodeDecodeError, PermissionError) as e:
    # 1. 记录错误
    log.error(f"无法读取 AGENTS.md: {e}")
    # 2. 使用上次缓存的合法内容
    content = get_cached_content("AGENTS.md")
    # 3. 提示用户检查文件
    notify_user("AGENTS.md 读取失败，使用缓存版本")
```

### 4.3 并发冲突处理

```python
with FileLock("MEMORY.md.lock"):
    # 安全地读取和写入
    content = read_file("MEMORY.md")
    updated = merge_content(content, new_entries)
    write_file("MEMORY.md", updated)
```

---

## 5. 安全考虑

### 5.1 隐私保护

- **MEMORY.md 隔离**: 共享上下文中严格禁止加载
- **敏感信息过滤**: 自动识别并过滤 API Key、密码等
- **访问审计**: 记录 MEMORY.md 的访问日志

### 5.2 文件系统安全

- **路径遍历防护**: 验证所有文件路径在 workspace 目录内
- **符号链接检查**: 拒绝访问指向 workspace 外部的符号链接
- **权限检查**: 确保文件可读可写

---

## 6. 依赖清单

| 依赖 | 版本 | 用途 |
|------|------|------|
| watchdog | ^3.0.0 | 文件系统监控 |
| APScheduler | ^3.10.0 | 定时任务调度 |
| aiofiles | ^23.0.0 | 异步文件操作 |
| filelock | ^3.13.0 | 文件锁机制 |
| pydantic | ^2.5.0 | 数据模型验证 |

---

## 7. 待澄清问题

无 - 所有技术决策已通过 research 阶段解决。

---

## 8. 结论

本研究确定了以下关键技术决策：

1. **文件监控**: `watchdog` 提供跨平台、高性能的文件变更检测
2. **定时任务**: `APScheduler` 支持可靠的记忆维护任务调度
3. **解析策略**: 保持简单，直接读取原始 Markdown 内容
4. **性能目标**: 通过异步 I/O 和缓存机制确保 < 1000ms 重载延迟
5. **安全策略**: 文件锁 + 路径验证 + 隐私隔离

所有决策符合宪法原则，特别是：
- **性能优先**: 异步非阻塞 I/O
- **关注点分离**: 加载器、检测器、构建器分层清晰
- **YAGNI**: 避免过度设计，聚焦核心需求
