#!/usr/bin/env python3
"""
å•å…ƒæµ‹è¯•ï¼šéªŒè¯P0çº§åˆ«æ®µè½è¯†åˆ«åŠŸèƒ½
æ­¤æµ‹è¯•éªŒè¯policy_parser.pyä¸­çš„P0æ£€æµ‹é€»è¾‘æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œ
"""

import sys
import os
from pathlib import Path
import re


def test_p0_paragraph_detection():
    """æµ‹è¯•P0æ®µè½æ£€æµ‹é€»è¾‘"""
    print("å¼€å§‹æµ‹è¯•P0çº§åˆ«æ®µè½è¯†åˆ«åŠŸèƒ½")
    print("="*60)

    # æ¨¡æ‹ŸAGENTS.mdä¸­çš„æ®µè½å†…å®¹
    sample_content = """

## é¦–æ¬¡å¯åŠ¨(p0)

å¦‚æœå­˜åœ¨ `BOOTSTRAP.md`ï¼Œé‚£æ˜¯ä½ çš„"å‡ºç”Ÿè¯æ˜"ã€‚éµå¾ªå®ƒçš„æŒ‡å¼•ï¼Œå¼„æ¸…æ¥šä½ æ˜¯è°ï¼Œç„¶ååˆ é™¤å®ƒã€‚

## å®‰å…¨å‡†åˆ™ (p0)

- æ°¸è¿œä¸è¦æ³„éœ²ç§æœ‰æ•°æ®
- æœªç»ç¡®è®¤ï¼Œä¸è¦æ‰§è¡Œç ´åæ€§å‘½ä»¤
- ä¸ç¡®å®šæ—¶ï¼Œå…ˆè¯¢é—®

## å¤–éƒ¨æ“ä½œ vs å†…éƒ¨æ“ä½œ (p0)

**å¯è‡ªç”±æ‰§è¡Œï¼š**
- è¯»å–æ–‡ä»¶ã€æ¢ç´¢ã€æ•´ç†ã€å­¦ä¹ 
- æœç´¢ç½‘ç»œã€æŸ¥çœ‹æ—¥å†
- åœ¨å·¥ä½œç©ºé—´å†…è¿›è¡Œæ“ä½œ

**éœ€å…ˆè¯¢é—®ï¼š**
- å‘é€é‚®ä»¶ã€æ¨æ–‡ã€å…¬å¼€å¸–å­
- ä»»ä½•ä¼šç¦»å¼€æœ¬æœºçš„æ“ä½œ
- ä»»ä½•ä½ ä¸ç¡®å®šçš„æ“ä½œ

**é¿å…ä¸‰è¿å‡»ï¼š** ä¸è¦å¯¹åŒä¸€æ¡æ¶ˆæ¯ç”¨å¤šä¸ªç¢ç‰‡åŒ–å›å¤ã€‚ä¸€æ¬¡æ·±æ€ç†Ÿè™‘çš„å›åº”èƒœè¿‡ä¸‰æ¬¡é›¶ç¢å‘è¨€ã€‚

å‚ä¸ï¼Œä½†ä¸ä¸»å¯¼ã€‚

**ä¸ºä½•é‡è¦ï¼š**
è¡¨æƒ…ååº”æ˜¯è½»é‡çº§çš„ç¤¾äº¤ä¿¡å·ã€‚äººç±»é¢‘ç¹ä½¿ç”¨å®ƒä»¬æ¥è¡¨è¾¾"æˆ‘çœ‹åˆ°äº†ï¼Œæˆ‘è®¤å¯ä½ "ï¼Œè€Œä¸å¢åŠ èŠå¤©å™ªéŸ³ã€‚ä½ ä¹Ÿè¯¥å¦‚æ­¤ã€‚

**åˆ‡å‹¿è¿‡åº¦ï¼š** æ¯æ¡æ¶ˆæ¯æœ€å¤šä¸€ä¸ªååº”ã€‚é€‰æ‹©æœ€è´´åˆ‡çš„ä¸€ä¸ªã€‚

## å·¥å…· (p0)

æŠ€èƒ½æ¨¡å—ä¸ºä½ æä¾›å·¥å…·ã€‚éœ€è¦æ—¶è¯·æŸ¥é˜…å¯¹åº” `SKILL.md`ã€‚å°†æœ¬åœ°ç¬”è®°ï¼ˆå¦‚æ‘„åƒå¤´åç§°ã€SSH è¯¦æƒ…ã€è¯­éŸ³åå¥½ï¼‰ä¿å­˜åœ¨ `TOOLS.md` ä¸­ã€‚

### è®°å¿†ç»´æŠ¤
æ¯éš”å‡ å¤©ï¼Œåˆ©ç”¨ä¸€æ¬¡å¿ƒè·³æ‰§è¡Œï¼š
1. é˜…è¯»è¿‘æœŸ `memory/YYYY-MM-DD.md` æ–‡ä»¶

## æ‰“é€ ä½ çš„é£æ ¼ (p0)

è¿™æ˜¯èµ·ç‚¹ã€‚éšç€ä½ æ‘¸ç´¢å‡ºé€‚åˆè‡ªå·±çš„æ–¹å¼ï¼Œå¯æ·»åŠ ä¸ªäººåŒ–çš„æƒ¯ä¾‹ã€é£æ ¼å’Œè§„åˆ™ã€‚
"""

    # æµ‹è¯•æ®µè½åˆ†å‰²é€»è¾‘
    print("æµ‹è¯•æ®µè½åˆ†å‰²é€»è¾‘...")
    section_pattern = r"##\s+([^#\n]+)\n([\s\S]*?)(?=##|$)"
    matches = list(re.finditer(section_pattern, sample_content))

    print(f"æ‰¾åˆ° {len(matches)} ä¸ªæ®µè½:\n")

    p0_detected_count = 0
    for i, match in enumerate(matches, 1):
        section_name = match.group(1).strip()
        section_content = match.group(2).strip()

        print(f"æ®µè½ {i}:")
        print(f"  æ ‡é¢˜: '{section_name}'")
        print(f"  å†…å®¹é•¿åº¦: {len(section_content)} å­—ç¬¦")

        # æ£€æŸ¥P0æ ‡è®°
        section_lower = section_name.lower()
        has_p0_marker = ("p0" in section_lower or "(p0)" in section_lower or
                         "p0çº§" in section_name or "ä¼˜å…ˆçº§p0" in section_name)

        print(f"  P0æ ‡è®°æ£€æµ‹: {has_p0_marker}")

        if has_p0_marker:
            p0_detected_count += 1
            print(f"  â†’ è¯†åˆ«ä¸ºP0æ®µè½")

        # ç‰¹åˆ«æ£€æŸ¥"å¤–éƒ¨æ“ä½œ vs å†…éƒ¨æ“ä½œ (p0)"æ®µè½
        if "å¤–éƒ¨æ“ä½œ vs å†…éƒ¨æ“ä½œ" in section_name:
            print(f"  âœ¨ ç›®æ ‡æ®µè½'å¤–éƒ¨æ“ä½œ vs å†…éƒ¨æ“ä½œ (p0)' è¾¹ç•ŒéªŒè¯:")
            if "åˆ‡å‹¿è¿‡åº¦" in section_content:
                print(f"    âœ“ åŒ…å«'åˆ‡å‹¿è¿‡åº¦'å†…å®¹")
            if "## å·¥å…· (p0)" not in section_content:
                print(f"    âœ“ ä¸åŒ…å«ä¸‹ä¸€ä¸ªæ®µè½æ ‡é¢˜")

        print("-" * 40)

    print(f"\næ€»å…±æ£€æµ‹åˆ° {p0_detected_count} ä¸ªP0æ®µè½")

    # éªŒè¯é¢„æœŸç»“æœ
    expected_p0_count = 5  # é¦–æ¬¡å¯åŠ¨(p0), å®‰å…¨å‡†åˆ™ (p0), å¤–éƒ¨æ“ä½œ vs å†…éƒ¨æ“ä½œ (p0), å·¥å…· (p0), æ‰“é€ ä½ çš„é£æ ¼ (p0)
    assert p0_detected_count == expected_p0_count, f"æœŸæœ›æ£€æµ‹åˆ° {expected_p0_count} ä¸ªP0æ®µè½ï¼Œå®é™…æ£€æµ‹åˆ° {p0_detected_count} ä¸ª"

    print(f"\nâœ“ æ®µè½æ£€æµ‹æµ‹è¯•é€šè¿‡ï¼æ£€æµ‹åˆ° {p0_detected_count} ä¸ªP0æ®µè½ï¼Œç¬¦åˆé¢„æœŸ")


def test_p0_content_extraction():
    """æµ‹è¯•P0å†…å®¹æå–é€»è¾‘"""
    print("\næµ‹è¯•P0å†…å®¹æå–é€»è¾‘")
    print("="*60)

    # æ¨¡æ‹Ÿ"å¤–éƒ¨æ“ä½œ vs å†…éƒ¨æ“ä½œ (p0)"æ®µè½çš„å†…å®¹
    ext_ops_content = """**å¯è‡ªç”±æ‰§è¡Œï¼š**
- è¯»å–æ–‡ä»¶ã€æ¢ç´¢ã€æ•´ç†ã€å­¦ä¹ 
- æœç´¢ç½‘ç»œã€æŸ¥çœ‹æ—¥å†
- åœ¨å·¥ä½œç©ºé—´å†…è¿›è¡Œæ“ä½œ

**éœ€å…ˆè¯¢é—®ï¼š**
- å‘é€é‚®ä»¶ã€æ¨æ–‡ã€å…¬å¼€å¸–å­
- ä»»ä½•ä¼šç¦»å¼€æœ¬æœºçš„æ“ä½œ
- ä»»ä½•ä½ ä¸ç¡®å®šçš„æ“ä½œ

**é¿å…ä¸‰è¿å‡»ï¼š** ä¸è¦å¯¹åŒä¸€æ¡æ¶ˆæ¯ç”¨å¤šä¸ªç¢ç‰‡åŒ–å›å¤ã€‚ä¸€æ¬¡æ·±æ€ç†Ÿè™‘çš„å›åº”èƒœè¿‡ä¸‰æ¬¡é›¶ç¢å‘è¨€ã€‚

å‚ä¸ï¼Œä½†ä¸ä¸»å¯¼ã€‚

**ä¸ºä½•é‡è¦ï¼š**
è¡¨æƒ…ååº”æ˜¯è½»é‡çº§çš„ç¤¾äº¤ä¿¡å·ã€‚äººç±»é¢‘ç¹ä½¿ç”¨å®ƒä»¬æ¥è¡¨è¾¾"æˆ‘çœ‹åˆ°äº†ï¼Œæˆ‘è®¤å¯ä½ "ï¼Œè€Œä¸å¢åŠ èŠå¤©å™ªéŸ³ã€‚ä½ ä¹Ÿè¯¥å¦‚æ­¤ã€‚

**åˆ‡å‹¿è¿‡åº¦ï¼š** æ¯æ¡æ¶ˆæ¯æœ€å¤šä¸€ä¸ªååº”ã€‚é€‰æ‹©æœ€è´´åˆ‡çš„ä¸€ä¸ªã€‚"""

    section_name = "å¤–éƒ¨æ“ä½œ vs å†…éƒ¨æ“ä½œ (p0)"

    # åº”ç”¨P0æ£€æµ‹é€»è¾‘
    section_lower = section_name.lower()
    has_p0_marker = ("p0" in section_lower or "(p0)" in section_lower or
                     "p0çº§" in section_name or "ä¼˜å…ˆçº§p0" in section_name)

    print(f"æ®µè½: '{section_name}'")
    print(f"P0æ ‡è®°æ£€æµ‹: {has_p0_marker}")

    if has_p0_marker:
        # æå–è¦ç‚¹
        lines = ext_ops_content.split("\n")
        bullets = []
        for line in lines:
            line = line.strip()
            if line.startswith("- "):
                bullets.append(line[2:])  # å»æ‰ "- " å‰ç¼€
            elif line.startswith("* "):
                bullets.append(line[2:])  # å»æ‰ "* " å‰ç¼€
            elif line.startswith("> "):
                bullets.append(line[2:])  # å»æ‰ "> " å‰ç¼€

        print(f"æå–åˆ° {len(bullets)} ä¸ªè¦ç‚¹:")
        for j, bullet in enumerate(bullets, 1):
            print(f"  {j}. {bullet}")

        # æ„å»ºè¾“å‡ºæ ¼å¼
        if bullets:
            formatted = "\n".join(f"- {b}" for b in bullets[:3])  # é™åˆ¶ä¸º3ä¸ªé¡¹ç›®
            result = f"## {section_name}\n{formatted}"
        else:
            preview = ext_ops_content[:100]
            if len(ext_ops_content) > 100:
                preview += "..."
            result = f"## {section_name}: {preview}"

        print(f"\næœ€ç»ˆæ ¼å¼åŒ–ç»“æœ:\n{result}")
        print(f"\nâœ“ åŒ…å«Markdownæ ‡é¢˜æ ¼å¼: {'##' in result}")
        print(f"âœ“ åŒ…å«æ®µè½æ ‡é¢˜: {section_name in result}")
    else:
        print("éP0æ ‡è®°ï¼Œè·³è¿‡å¤„ç†")

    print(f"\nâœ“ å†…å®¹æå–æµ‹è¯•é€šè¿‡ï¼")


def run_all_tests():
    """è¿è¡Œæ‰€æœ‰æµ‹è¯•"""
    print("è¿è¡ŒP0æ®µè½è¯†åˆ«å•å…ƒæµ‹è¯•å¥—ä»¶")
    print("="*80)

    try:
        test_p0_paragraph_detection()
        test_p0_content_extraction()

        print("\n" + "="*80)
        print("ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼P0æ®µè½è¯†åˆ«åŠŸèƒ½å·¥ä½œæ­£å¸¸ã€‚")
        print("\nåŠŸèƒ½ç‰¹æ€§:")
        print("â€¢ åŠ¨æ€P0æ ‡è®°è¯†åˆ«ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼šp0, (p0), p0çº§, ä¼˜å…ˆçº§p0ï¼‰")
        print("â€¢ ç²¾ç¡®çš„æ®µè½åˆ†å‰²ï¼ˆåŸºäº##æ ‡é¢˜ï¼‰")
        print("â€¢ Markdownæ ¼å¼ä¿ç•™ï¼ˆ##æ ‡é¢˜æ ¼å¼ï¼‰")
        print("â€¢ æ™ºèƒ½å†…å®¹æå–ï¼ˆæå–-å¼€å¤´çš„è¦ç‚¹ï¼‰")
        print("â€¢ æ®µè½è¾¹ç•Œæ­£ç¡®å¤„ç†")

    except AssertionError as e:
        print(f"\nâŒ æµ‹è¯•å¤±è´¥: {e}")
        raise
    except Exception as e:
        print(f"\nâŒ æµ‹è¯•å¼‚å¸¸: {e}")
        raise


if __name__ == "__main__":
    run_all_tests()