# 全链路追踪可视化系统

## 目标
基于traceId分析x-agent.log和prompt-llm.log日志，结合项目代码结构，可视化展示从用户发送消息到最终结束的全流程，包含重要模块、类、方法、参数、LLM调用、工具技能等信息。

## 架构设计

### 1. 后端增强 (Backend Enhancement)

#### 1.1 增强日志记录系统
**文件**: `backend/src/utils/logger.py`

添加追踪装饰器和关键点日志:
```python
# 新增追踪装饰器
@log_execution  # 自动记录方法进入/退出和耗时
def critical_method(...):
    ...
```

**关键点增强**:
- Agent.chat() 入口/出口
- LLMRouter.chat() 选择provider和failover逻辑
- 中间件执行 (TracingMiddleware, ErrorHandler)
- Plugin执行 (on_message, on_response钩子)
- Memory operations (记忆检索/存储)

#### 1.2 追踪数据分析API
**文件**: `backend/src/api/v1/trace.py` (新建)

**端点设计**:

```python
# 获取trace原始数据
GET /api/v1/trace/{trace_id}/raw
Response: {
  "x_agent_logs": [...],  # 从x-agent.log提取
  "prompt_llm_logs": [...], # 从prompt-llm.log提取
  "trace_id": "xxx",
  "session_id": "xxx",
  "start_time": "...",
  "end_time": "...",
  "total_duration_ms": 1234
}

# 获取trace流程图数据
GET /api/v1/trace/{trace_id}/flow
Response: {
  "nodes": [...],  # React Flow节点
  "edges": [...],  # React Flow边
  "metadata": {...}
}

# 请求LLM分析trace
POST /api/v1/trace/{trace_id}/analyze
Request: {
  "focus_areas": ["performance", "error", "llm_usage"],  # 可选
  "include_suggestions": true
}
Response: {
  "analysis": "LLM生成的分析文本",
  "insights": [
    {
      "type": "performance|error|optimization",
      "title": "...",
      "description": "...",
      "location": "module.class.method"
    }
  ],
  "suggestions": [...]
}
```

#### 1.3 代码结构分析器
**文件**: `backend/src/services/code_analyzer.py` (新建)

功能:
- 使用AST解析Python代码，构建调用关系图
- 提取关键模块、类、方法签名
- 生成执行路径模板 (template call graph)

示例输出:
```python
{
  "modules": {
    "api.v1.chat": {
      "classes": {},
      "functions": ["chat"],
      "calls": ["agent.chat"]
    },
    "core.agent": {
      "classes": {
        "Agent": {
          "methods": ["chat", "_chat_streaming"],
          "calls": ["session_manager.add_message", "llm_router.chat"]
        }
      }
    }
  },
  "call_graph": {
    "chat (api.v1.chat)": ["Agent.chat"],
    "Agent.chat": ["SessionManager.add_message", "LLMRouter.chat"],
    ...
  }
}
```

#### 1.4 日志解析器
**文件**: `backend/src/services/log_parser.py` (新建)

功能:
- 按trace_id过滤和聚合日志
- 解析日志中的结构化信息 (时间戳、模块、事件、extra字段)
- 构建时间线 (timeline) 和执行路径

示例输出:
```python
{
  "trace_id": "xxx",
  "timeline": [
    {
      "timestamp": "2026-02-15T10:00:00.123Z",
      "module": "api.middleware.tracing",
      "event": "Request started",
      "data": {"method": "POST", "path": "/api/v1/chat"}
    },
    {
      "timestamp": "2026-02-15T10:00:00.345Z",
      "module": "core.agent",
      "event": "Processing chat message",
      "data": {"session_id": "abc", "message_length": 50}
    },
    {
      "timestamp": "2026-02-15T10:00:01.234Z",
      "module": "services.llm.router",
      "event": "LLM request",
      "data": {"provider": "primary", "model": "qwen3"}
    },
    {
      "timestamp": "2026-02-15T10:00:02.567Z",
      "module": "services.llm.router",
      "event": "LLM response received",
      "data": {"latency_ms": 1333, "tokens": 187}
    }
  ],
  "execution_path": [
    "api.v1.chat.chat",
    "core.agent.Agent.chat",
    "services.llm.router.LLMRouter.chat",
    "services.llm.openai_provider.OpenAIProvider.chat"
  ]
}
```

#### 1.5 流程图生成器
**文件**: `backend/src/services/flow_builder.py` (新建)

功能:
- 结合代码结构和日志数据，生成React Flow图结构
- 分类节点类型 (API、Middleware、Agent、LLM、Memory、Plugin、Tool)
- 计算节点间的时序和耗时
- 支持可配置的详细级别 (high-level / detailed)

示例输出:
```python
{
  "nodes": [
    {
      "id": "node-1",
      "type": "api",
      "data": {
        "label": "POST /chat",
        "module": "api.v1.chat",
        "function": "chat",
        "params": {"message": "你好", "session_id": "abc"},
        "timestamp": "...",
        "duration_ms": 2444
      },
      "position": {"x": 100, "y": 100}
    },
    {
      "id": "node-2",
      "type": "middleware",
      "data": {
        "label": "TracingMiddleware",
        "action": "generate trace_id",
        "duration_ms": 1
      },
      "position": {"x": 100, "y": 200}
    },
    {
      "id": "node-3",
      "type": "agent",
      "data": {
        "label": "Agent.chat",
        "module": "core.agent",
        "method": "chat",
        "duration_ms": 2300
      },
      "position": {"x": 100, "y": 300}
    },
    {
      "id": "node-4",
      "type": "llm",
      "data": {
        "label": "LLM Request",
        "provider": "primary",
        "model": "qwen3-coder-flash",
        "prompt_tokens": 60,
        "completion_tokens": 127,
        "total_tokens": 187,
        "latency_ms": 1402,
        "request_preview": "System: 你是测试助手...\nUser: 你好"
      },
      "position": {"x": 100, "y": 400}
    }
  ],
  "edges": [
    {"id": "e1-2", "source": "node-1", "target": "node-2"},
    {"id": "e2-3", "source": "node-2", "target": "node-3"},
    {"id": "e3-4", "source": "node-3", "target": "node-4"}
  ]
}
```

#### 1.6 LLM分析服务
**文件**: `backend/src/services/trace_analyzer.py` (新建)

功能:
- 接收trace数据（日志+代码结构）
- 调用Primary LLM进行智能分析
- 提取性能瓶颈、错误原因、优化建议

Prompt设计:
```python
"""
你是一个系统调试专家，请分析以下X-Agent系统的执行trace：

## Trace信息
- Trace ID: {trace_id}
- 执行时长: {duration_ms}ms
- 调用路径: {execution_path}

## 日志详情
{formatted_logs}

## 代码结构
{code_structure}

请分析：
1. 性能瓶颈（哪些环节耗时最多？）
2. 潜在问题（是否有异常或错误？）
3. LLM使用效率（token使用是否合理？）
4. 优化建议（如何提升性能和可靠性？）

以结构化JSON格式回复。
"""
```

### 2. 前端实现 (Frontend Implementation)

#### 2.1 TraceViewer组件
**文件**: `frontend/src/components/trace/TraceViewer.tsx` (新建)

核心组件：
```typescript
interface TraceViewerProps {
  traceId: string;
}

export function TraceViewer({ traceId }: TraceViewerProps) {
  const [flowData, setFlowData] = useState<FlowData | null>(null);
  const [analysis, setAnalysis] = useState<Analysis | null>(null);
  const [detailLevel, setDetailLevel] = useState<'high' | 'medium' | 'detailed'>('high');
  
  // 加载trace流程数据
  useEffect(() => {
    fetchTraceFlow(traceId, detailLevel).then(setFlowData);
  }, [traceId, detailLevel]);
  
  return (
    <div className="trace-viewer">
      {/* 顶部工具栏 */}
      <TraceToolbar
        traceId={traceId}
        onAnalyze={() => analyzeTrace(traceId)}
        onDetailLevelChange={setDetailLevel}
      />
      
      {/* 流程图区域 */}
      <FlowCanvas data={flowData} />
      
      {/* 侧边栏：分析结果 */}
      {analysis && <AnalysisPanel analysis={analysis} />}
    </div>
  );
}
```

#### 2.2 FlowCanvas组件
**文件**: `frontend/src/components/trace/FlowCanvas.tsx` (新建)

使用React Flow库：
```typescript
import ReactFlow, { Background, Controls, MiniMap } from 'reactflow';
import 'reactflow/dist/style.css';

// 自定义节点类型
import { APINode } from './nodes/APINode';
import { MiddlewareNode } from './nodes/MiddlewareNode';
import { AgentNode } from './nodes/AgentNode';
import { LLMNode } from './nodes/LLMNode';
import { MemoryNode } from './nodes/MemoryNode';
import { PluginNode } from './nodes/PluginNode';

const nodeTypes = {
  api: APINode,
  middleware: MiddlewareNode,
  agent: AgentNode,
  llm: LLMNode,
  memory: MemoryNode,
  plugin: PluginNode,
};

export function FlowCanvas({ data }: FlowCanvasProps) {
  return (
    <ReactFlow
      nodes={data.nodes}
      edges={data.edges}
      nodeTypes={nodeTypes}
      fitView
    >
      <Background />
      <Controls />
      <MiniMap />
    </ReactFlow>
  );
}
```

#### 2.3 自定义节点组件
**文件**: `frontend/src/components/trace/nodes/*.tsx` (新建)

每个节点类型有独特的视觉样式和信息展示：

**APINode**: 显示HTTP请求信息  
**AgentNode**: 显示Agent方法调用  
**LLMNode**: 显示模型、token使用、耗时（重点突出）  
**MemoryNode**: 显示记忆检索/存储操作  
**PluginNode**: 显示插件名称和钩子类型  
**MiddlewareNode**: 显示中间件名称和处理逻辑

节点设计特点：
- 颜色编码（按类型）
- 悬停显示详细信息
- 点击展开完整数据
- 耗时标注（边上或节点内）

#### 2.4 AnalysisPanel组件
**文件**: `frontend/src/components/trace/AnalysisPanel.tsx` (新建)

展示LLM分析结果：
```typescript
interface AnalysisPanelProps {
  analysis: Analysis;
}

export function AnalysisPanel({ analysis }: AnalysisPanelProps) {
  return (
    <div className="analysis-panel">
      <h3>智能分析</h3>
      
      {/* 性能瓶颈 */}
      <Section title="性能瓶颈">
        {analysis.insights
          .filter(i => i.type === 'performance')
          .map(insight => <InsightCard key={insight.title} insight={insight} />)}
      </Section>
      
      {/* 错误分析 */}
      <Section title="错误分析">
        {analysis.insights
          .filter(i => i.type === 'error')
          .map(insight => <InsightCard key={insight.title} insight={insight} />)}
      </Section>
      
      {/* 优化建议 */}
      <Section title="优化建议">
        {analysis.suggestions.map(s => <SuggestionCard key={s} suggestion={s} />)}
      </Section>
    </div>
  );
}
```

#### 2.5 TraceSearch组件
**文件**: `frontend/src/components/trace/TraceSearch.tsx` (新建)

允许用户输入trace_id进行查询：
```typescript
export function TraceSearch() {
  const [traceId, setTraceId] = useState('');
  const navigate = useNavigate();
  
  const handleSearch = () => {
    if (traceId) {
      navigate(`/trace/${traceId}`);
    }
  };
  
  return (
    <div className="trace-search">
      <input
        type="text"
        value={traceId}
        onChange={(e) => setTraceId(e.target.value)}
        placeholder="输入 Trace ID..."
      />
      <button onClick={handleSearch}>查看追踪</button>
    </div>
  );
}
```

#### 2.6 集成到开发者模式
**文件**: `frontend/src/components/dev/DevModeWindow.tsx` (修改)

在PromptLogList的每条记录上添加"Trace"按钮：
```typescript
// 在PromptLogList.tsx中，每条日志记录添加：
<button
  onClick={() => window.open(`/trace/${log.trace_id}`, '_blank')}
  className="trace-btn"
>
  查看Trace
</button>
```

或者创建独立的路由：
```typescript
// App.tsx 添加路由
<Route path="/trace/:traceId" element={<TraceViewerPage />} />
```

### 3. 类型定义
**文件**: `frontend/src/types/trace.ts` (新建)

```typescript
export interface TraceRawData {
  trace_id: string;
  session_id: string;
  x_agent_logs: LogEntry[];
  prompt_llm_logs: PromptLogEntry[];
  start_time: string;
  end_time: string;
  total_duration_ms: number;
}

export interface FlowData {
  nodes: FlowNode[];
  edges: FlowEdge[];
  metadata: TraceMetadata;
}

export interface FlowNode {
  id: string;
  type: 'api' | 'middleware' | 'agent' | 'llm' | 'memory' | 'plugin' | 'tool';
  data: NodeData;
  position: { x: number; y: number };
}

export interface NodeData {
  label: string;
  module?: string;
  function?: string;
  method?: string;
  params?: Record<string, any>;
  result?: any;
  duration_ms?: number;
  timestamp?: string;
  // LLM特有
  provider?: string;
  model?: string;
  token_usage?: TokenUsage;
  // 其他扩展字段...
}

export interface FlowEdge {
  id: string;
  source: string;
  target: string;
  label?: string;  // 可选：显示耗时
  animated?: boolean;
}

export interface Analysis {
  analysis: string;  // LLM生成的完整分析文本
  insights: Insight[];
  suggestions: string[];
}

export interface Insight {
  type: 'performance' | 'error' | 'optimization';
  title: string;
  description: string;
  location?: string;
  severity?: 'low' | 'medium' | 'high';
}
```

### 4. 服务层
**文件**: `frontend/src/services/trace.ts` (新建)

```typescript
export async function getTraceRawData(traceId: string): Promise<TraceRawData> {
  const response = await fetch(`${API_BASE_URL}/trace/${traceId}/raw`);
  if (!response.ok) throw new Error('Failed to fetch trace data');
  return response.json();
}

export async function getTraceFlow(
  traceId: string,
  detailLevel: 'high' | 'medium' | 'detailed' = 'high'
): Promise<FlowData> {
  const response = await fetch(
    `${API_BASE_URL}/trace/${traceId}/flow?detail_level=${detailLevel}`
  );
  if (!response.ok) throw new Error('Failed to fetch trace flow');
  return response.json();
}

export async function analyzeTrace(
  traceId: string,
  options?: { focus_areas?: string[]; include_suggestions?: boolean }
): Promise<Analysis> {
  const response = await fetch(`${API_BASE_URL}/trace/${traceId}/analyze`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(options || {}),
  });
  if (!response.ok) throw new Error('Failed to analyze trace');
  return response.json();
}
```

## 实施步骤

### Phase 1: 基础设施（后端）
1. 增强日志系统，添加trace装饰器
2. 实现日志解析器 (log_parser.py)
3. 实现代码结构分析器 (code_analyzer.py)
4. 创建trace API端点 (trace.py)

### Phase 2: 流程图生成（后端+前端）
5. 实现流程图生成器 (flow_builder.py)
6. 创建前端trace类型定义
7. 实现React Flow基础组件
8. 创建自定义节点类型

### Phase 3: 可视化界面（前端）
9. 实现TraceViewer主组件
10. 实现FlowCanvas组件
11. 集成到开发者模式或创建独立路由

### Phase 4: 智能分析（后端+前端）
12. 实现LLM trace分析服务
13. 实现AnalysisPanel组件
14. 连接分析功能到UI

### Phase 5: 优化和完善
15. 性能优化（大流程图渲染）
16. 添加交互功能（节点过滤、搜索、导出）
17. 美化UI和提升用户体验
18. 编写文档和测试

## 技术栈

**后端**:
- FastAPI (API endpoints)
- Python AST (代码分析)
- 正则表达式/JSON (日志解析)
- LLMRouter (智能分析)

**前端**:
- React + TypeScript
- React Flow (流程图可视化)
- Tailwind CSS (样式)
- Fetch API (数据请求)

## 预期效果

用户可以：
1. 在开发者模式中点击"查看Trace"按钮
2. 看到完整的执行流程可视化图
3. 调整详细级别（高层/详细）
4. 点击分析按钮，获取LLM生成的智能分析
5. 定位性能瓶颈和潜在问题
6. 获得具体的优化建议

流程图特点：
- 清晰简约，分类清晰（颜色编码）
- 交互式（拖拽、缩放、点击查看详情）
- 时序明确（从上到下或从左到右）
- 重点突出（LLM调用、耗时长的操作）
