# Plan ä¼˜åŒ–å®Œæ•´æ–¹æ¡ˆï¼šæ¸…æ™°è§„åˆ’ + ç²¾å‡†è°ƒç”¨ + æµå¼åé¦ˆ

## ğŸ¯ æ ¸å¿ƒé—®é¢˜å›é¡¾

### Trace æ¡ˆä¾‹åˆ†æ (fbfe52d8-48ea-45a0-b464-84391b845882)
- **åˆå§‹ Plan**: 5 æ­¥ï¼ˆåŒ…å«çº¯éªŒè¯æ­¥éª¤ï¼Œè¿å YAGNIï¼‰
- **å®é™…æ‰§è¡Œ**: Step 5 åœæ» 3 æ¬¡ â†’ è§¦å‘ Replan â†’ ä¼˜åŒ–ä¸º 4 æ­¥
- **ç†è®ºæœ€ä¼˜**: 3 æ­¥ï¼ˆweb_search â†’ write_file â†’ pdf_createï¼‰

### æ ¹æœ¬é—®é¢˜
1. **Plan ç”Ÿæˆè´¨é‡å·®**: åŒ…å«è¿‡åº¦éªŒè¯æ­¥éª¤
2. **å·¥å…·è°ƒç”¨ä¸ç²¾å‡†**: è¯­ä¹‰æ ‡ç­¾ vs çœŸå®å·¥å…·æ··æ·†
3. **æ—¥å¿—ä¸å®Œæ•´**: ç¼ºå°‘ Plan è¯¦ç»†å†…å®¹è®°å½•
4. **ç”¨æˆ·ä½“éªŒå¾…ä¼˜åŒ–**: ç¼ºå°‘æµå¼è¿›åº¦åé¦ˆ

---

## ğŸ“‹ å®æ–½æ–¹æ¡ˆ

### Phase 1: Plan ç”Ÿæˆè´¨é‡ä¼˜åŒ– (P0 - æœ€é«˜ä¼˜å…ˆçº§)

#### 1.1 LightPlanner Prompt é‡æ„
**ç›®æ ‡**: éµå¾ªæœ€çŸ­è·¯å¾„åŸåˆ™ï¼Œç¦æ­¢çº¯éªŒè¯æ­¥éª¤

**æ–‡ä»¶**: `src/orchestrator/light_planner.py`

**ä¿®æ”¹è¦ç‚¹**:
```python
LIGHT_PLANNER_PROMPT = """ä½ æ˜¯ä¸€ä½æç®€ä»»åŠ¡è§„åˆ’ä¸“å®¶ã€‚

ã€æ ¸å¿ƒåŸåˆ™ã€‘
1. YAGNI (You Aren't Gonna Need It): 
   - æ¯ä¸ª step å¿…é¡»ç›´æ¥è´¡çŒ®äº goal
   - ç¦æ­¢çº¯éªŒè¯æ­¥éª¤ï¼ˆéªŒè¯åº”å†…å»ºåˆ° step ä¸­ï¼‰
   - If not called, remove it

2. æœ€çŸ­è·¯å¾„:
   - ç”¨æœ€å°‘æ­¥éª¤å®Œæˆ goal
   - ç›¸ä¼¼æ“ä½œå¿…é¡»åˆå¹¶ï¼ˆå¦‚è¿ç»­ write_fileï¼‰
   - ç›®æ ‡ï¼šæœ€å°å¿…è¦æ­¥éª¤æ•°

3. å·¥å…·è¯­ä¹‰æ¸…æ™°:
   - ä½¿ç”¨çœŸå®å·¥å…·åï¼šweb_search, write_file, run_in_terminal
   - ç¦æ­¢è™šæ„å·¥å…·ï¼špdf_create åº”æè¿°ä¸º "ä½¿ç”¨ write_file åˆ›å»º Python è„šæœ¬ç”Ÿæˆ PDF"

ã€è¾“å‡ºæ ¼å¼ã€‘
ä¸¥æ ¼è¿”å› JSON æ•°ç»„ï¼Œæ¯ä¸ª step åŒ…å«:
{
  "name": "ç®€æ´çš„åŠ¨ä½œæè¿°",
  "tool": "çœŸå®å·¥å…·å",
  "description": "è¯¦ç»†è¯´æ˜ï¼ŒåŒ…æ‹¬å¦‚ä½•éªŒè¯æˆåŠŸ"
}

ã€ç¤ºä¾‹å¯¹æ¯”ã€‘
âŒ é”™è¯¯ Plan (5 æ­¥ï¼ŒåŒ…å«è¿‡åº¦éªŒè¯):
1. web_search: æœç´¢ä¿¡æ¯
2. write_file: æ•´ç†èµ„æ–™
3. write_file: æ’°å†™æ–‡ç« 
4. pdf_create: ç”Ÿæˆ PDF
5. list_dir: éªŒè¯ PDF æ˜¯å¦ç”Ÿæˆ â† è¿‡åº¦éªŒè¯

âœ… æ­£ç¡® Plan (3 æ­¥ï¼Œæœ€çŸ­è·¯å¾„):
1. web_search: æœç´¢"2026 AI å‘å±•è¶‹åŠ¿"ï¼Œæ”¶é›†å…³é”®ä¿¡æ¯
2. write_file: æ•´åˆæœç´¢ç»“æœï¼Œæ’°å†™ç ”ç©¶æŠ¥å‘Š (MD æ ¼å¼)
3. write_file + run_in_terminal: åˆ›å»º Python è„šæœ¬ä½¿ç”¨ reportlab ç”Ÿæˆ PDFï¼Œè„šæœ¬æ‰§è¡ŒæˆåŠŸå³éªŒè¯é€šè¿‡
"""
```

#### 1.2 StructuredPlanner æŠ€èƒ½ç»‘å®šä¼˜åŒ–
**ç›®æ ‡**: æ˜ç¡® skill_binding ä¸å®é™…å·¥å…·çš„æ˜ å°„å…³ç³»

**æ–‡ä»¶**: `src/orchestrator/structured_planner.py`

**ä¿®æ”¹è¦ç‚¹**:
```python
TASK_TYPE_RULES = {
    "creation": {
        "keywords": ["åˆ›å»º", "ç”Ÿæˆ", "å†™", "åˆ¶ä½œ", "å¼€å‘"],
        "required_skills": ["write_file"],  # æ˜ç¡®å¿…éœ€æŠ€èƒ½
        "forbidden": [],  # æ— ç¦ç”¨æŠ€èƒ½
        "validation": "internal"  # éªŒè¯å†…å»ºï¼Œéç‹¬ç«‹æ­¥éª¤
    },
    "pdf_creation": {
        "keywords": ["pdf", "PDF"],
        "required_skills": ["write_file", "run_in_terminal"],  # PDF éœ€è¦ä¸¤æ­¥
        "implementation": "Python + reportlab",  # æ˜ç¡®å®ç°æ–¹å¼
        "system_prompt_rule": "pdf_skill_guidelines"  # å¼•ç”¨ System Prompt è§„åˆ™
    }
}
```

---

### Phase 2: å·¥å…·è°ƒç”¨ç²¾å‡†åŒ– (P1)

#### 2.1 å·¥å…·è¯­ä¹‰æ˜ å°„è¡¨
**ç›®æ ‡**: æ¾„æ¸…è¯­ä¹‰æ ‡ç­¾ä¸çœŸå®å·¥å…·çš„å¯¹åº”å…³ç³»

**æ–‡ä»¶**: `src/tools/semantic_mapping.py` (æ–°å»º)

```python
"""å·¥å…·è¯­ä¹‰æ˜ å°„è¡¨

æ¾„æ¸… Plan ä¸­çš„è¯­ä¹‰æ ‡ç­¾ä¸å®é™…è°ƒç”¨çš„å·¥å…·ä¹‹é—´çš„å…³ç³»ã€‚
"""

TOOL_SEMANTIC_MAP = {
    # === çœŸå®å·¥å…·ï¼ˆç›´æ¥è°ƒç”¨ï¼‰===
    "web_search": {
        "type": "builtin_tool",
        "module": "src.tools.builtin.aliyun_web_search",
        "description": "é˜¿é‡Œäº‘ web search API"
    },
    "write_file": {
        "type": "builtin_tool", 
        "module": "src.tools.builtin.file_ops",
        "description": "å†™å…¥æ–‡ä»¶åˆ°æœ¬åœ°"
    },
    "run_in_terminal": {
        "type": "builtin_tool",
        "module": "src.tools.builtin.terminal",
        "description": "æ‰§è¡Œç»ˆç«¯å‘½ä»¤"
    },
    
    # === è¯­ä¹‰æ ‡ç­¾ï¼ˆéœ€åˆ†è§£ä¸ºçœŸå®å·¥å…·ï¼‰===
    "pdf_create": {
        "type": "semantic_label",
        "decomposition": [
            {"tool": "write_file", "action": "åˆ›å»º Python è„šæœ¬"},
            {"tool": "run_in_terminal", "action": "æ‰§è¡Œè„šæœ¬"}
        ],
        "skill_constraint": "pdf_skill_guidelines",
        "implementation_guide": "Python + reportlabï¼Œç¦ç”¨ Node.js PDFKit"
    },
    "pptx_create": {
        "type": "semantic_label",
        "decomposition": [
            {"tool": "write_file", "action": "åˆ›å»º Node.js è„šæœ¬"},
            {"tool": "run_in_terminal", "action": "æ‰§è¡Œè„šæœ¬"}
        ],
        "skill_constraint": "pptx_skill_guidelines",
        "implementation_guide": "Node.js + PptxGenJS"
    },
    "verify_file": {  # ç¦æ­¢ä½œä¸ºç‹¬ç«‹æ­¥éª¤ï¼
        "type": "deprecated_label",
        "reason": "éªŒè¯åº”å†…å»ºåˆ° step ä¸­ï¼Œä¸åº”ç‹¬ç«‹",
        "alternative": "åœ¨ step description ä¸­è¯´æ˜å¦‚ä½•éªŒè¯"
    }
}
```

#### 2.2 Task Analyzer æŠ€èƒ½è·¯ç”±å¢å¼º
**ç›®æ ‡**: åŸºäºè¯­ä¹‰ç²¾å‡†åŒ¹é… Skills

**æ–‡ä»¶**: `src/orchestrator/task_analyzer.py`

**ä¿®æ”¹è¦ç‚¹**:
```python
class TaskAnalyzer:
    def __init__(self, skill_router: SkillRouter, skill_registry: SkillRegistry):
        self.skill_router = skill_router
        self.skill_registry = skill_registry
        # æ–°å¢ï¼šæŠ€èƒ½å…ƒæ•°æ®ç¼“å­˜
        self._skill_metadata_cache = {}
    
    def analyze(self, user_message: str) -> TaskAnalysis:
        # ... ç°æœ‰ä»£ç  ...
        
        # P2-2 ENHANCED: è¯­ä¹‰è·¯ç”± + æŠ€èƒ½å…ƒæ•°æ®
        semantic_matches = []
        if self.skill_router:
            try:
                # è·å– Top-3 åŒ¹é…çš„ skills
                semantic_matches = self.skill_router.route(user_message, top_k=3)
                
                # æ–°å¢ï¼šè·å–æŠ€èƒ½å…ƒæ•°æ®ï¼ˆå®ç°æ–¹å¼ã€ä¾èµ–å·¥å…·ï¼‰
                enhanced_matches = []
                for skill_name, score in semantic_matches:
                    metadata = self._get_skill_implementation_info(skill_name)
                    enhanced_matches.append({
                        "skill_name": skill_name,
                        "score": score,
                        "implementation": metadata["implementation"],  # e.g., "Python + reportlab"
                        "tools_required": metadata["tools"]  # e.g., ["write_file", "run_in_terminal"]
                    })
                
                logger.info(
                    "Enhanced semantic skill matching completed",
                    extra={
                        "task": user_message[:50],
                        "semantic_matches": enhanced_matches,
                    }
                )
                
            except Exception as e:
                logger.warning(f"Semantic routing failed: {e}")
```

---

### Phase 3: æ—¥å¿—å¢å¼º - Plan è¯¦ç»†å†…å®¹è®°å½• (P0)

#### 3.1 Plan Generation æ—¥å¿—å¢å¼º
**æ–‡ä»¶**: `src/orchestrator/engine.py`, `src/orchestrator/light_planner.py`

```python
# engine.py - Process request æ–¹æ³•
async def process_request(self, user_message: str, session_id: str):
    # ... ç°æœ‰ä»£ç  ...
    
    # Step 1: Task Analysis
    analysis = self._task_analyzer.analyze(user_message)
    
    # NEW: è¯¦ç»†è®°å½• Task Analysis ç»“æœ
    logger.info(
        "Task analysis detailed result",
        extra={
            "session_id": session_id,
            "complexity": analysis.complexity,
            "needs_plan": analysis.needs_plan,
            "matched_skills": analysis.matched_skills,
            "indicators": {
                "action_verbs": analysis.indicators.get("action_verbs", []),
                "target_objects": analysis.indicators.get("target_objects", []),
                "research_creation": analysis.indicators.get("research_creation", [])
            }
        }
    )
    
    # Step 2: Plan Generation (if needed)
    if analysis.needs_plan:
        plan = await self._light_planner.generate(user_message)
        
        # NEW: è¯¦ç»†è®°å½• Plan å†…å®¹
        logger.info(
            "Plan generation detailed result",
            extra={
                "session_id": session_id,
                "plan_id": plan.id,
                "goal": plan.goal,
                "steps_count": len(plan.steps),
                "steps_detail": [
                    {
                        "id": step.id,
                        "name": step.name,
                        "tool": step.tool,
                        "description": step.description,
                        "expected_output": step.expected_output
                    }
                    for step in plan.steps
                ],
                "milestones": [m.name for m in plan.milestones],
                "estimated_iterations": len(plan.steps) + 2  # steps + validation buffer
            }
        )
```

#### 3.2 Plan Execution æ—¥å¿—å¢å¼º
```python
# engine.py - Execute plan æ–¹æ³•
async def _execute_plan_step(self, step: PlanStep):
    # BEFORE execution
    logger.info(
        "Plan step execution started",
        extra={
            "step_id": step.id,
            "step_name": step.name,
            "tool": step.tool,
            "session_id": self.session_id
        }
    )
    
    # AFTER execution
    logger.info(
        "Plan step execution completed",
        extra={
            "step_id": step.id,
            "success": True,
            "actual_output": result[:200],  # æˆªæ–­é¿å…è¿‡é•¿
            "next_step_ready": True
        }
    )
```

---

### Phase 4: å‰ç«¯æµå¼åé¦ˆ UI (P1)

#### 4.1 WebSocket äº‹ä»¶ç±»å‹æ‰©å±•
**æ–‡ä»¶**: `src/api/websocket.py`, `src/orchestrator/engine.py`

```python
# æ–°å¢äº‹ä»¶ç±»å‹å®šä¹‰
class PlanEventType(str, Enum):
    PLAN_GENERATION_START = "plan_generation_start"
    PLAN_GENERATION_PROGRESS = "plan_generation_progress"
    PLAN_GENERATION_COMPLETE = "plan_generation_complete"
    PLAN_STEP_START = "plan_step_start"
    PLAN_STEP_COMPLETE = "plan_step_complete"
    PLAN_MILESTONE_REACHED = "plan_milestone_reached"
    PLAN_VALIDATION = "plan_validation"

# websocket.py - å‘é€æµå¼äº‹ä»¶
async def send_plan_event(event_type: PlanEventType, data: dict):
    """å‘é€ Plan ç›¸å…³äº‹ä»¶åˆ°å‰ç«¯"""
    event = {
        "type": event_type.value,
        "trace_id": current_trace_id,
        "timestamp": datetime.now().isoformat(),
        "data": data
    }
    await websocket.send_json(event)
```

#### 4.2 Engine é›†æˆæµå¼äº‹ä»¶
```python
# engine.py - Process request æ–¹æ³•å¢å¼º
async def process_request(self, user_message: str, session_id: str):
    # === 1. Task Analysis ===
    await self._send_plan_event(PlanEventType.PLAN_GENERATION_START, {
        "message": "æ­£åœ¨åˆ†æä»»åŠ¡å¤æ‚åº¦...",
        "stage": "task_analysis"
    })
    
    analysis = self._task_analyzer.analyze(user_message)
    
    if analysis.needs_plan:
        # === 2. Plan Generation ===
        await self._send_plan_event(PlanEventType.PLAN_GENERATION_PROGRESS, {
            "message": f"æ£€æµ‹åˆ°å¤æ‚ä»»åŠ¡ï¼Œæ­£åœ¨ç”Ÿæˆè®¡åˆ’... (é¢„è®¡ {len(analysis.matched_skills)} ä¸ªæŠ€èƒ½å‚ä¸)",
            "matched_skills": analysis.matched_skills,
            "stage": "plan_generation"
        })
        
        plan = await self._light_planner.generate(user_message)
        
        await self._send_plan_event(PlanEventType.PLAN_GENERATION_COMPLETE, {
            "message": f"è®¡åˆ’å·²ç”Ÿæˆï¼š{len(plan.steps)} ä¸ªæ­¥éª¤",
            "plan_preview": "\n".join([f"{i+1}. {s.name}" for i, s in enumerate(plan.steps)]),
            "estimated_time": "~30 ç§’"  # åŸºäºå†å²æ•°æ®ä¼°ç®—
        })
        
        # === 3. Plan Execution with Streaming ===
        for i, step in enumerate(plan.steps):
            await self._send_plan_event(PlanEventType.PLAN_STEP_START, {
                "step_number": i + 1,
                "total_steps": len(plan.steps),
                "step_name": step.name,
                "tool": step.tool,
                "progress_percent": int((i / len(plan.steps)) * 100)
            })
            
            result = await self._execute_plan_step(step)
            
            await self._send_plan_event(PlanEventType.PLAN_STEP_COMPLETE, {
                "step_number": i + 1,
                "success": True,
                "output_preview": result[:100] + "..." if len(result) > 100 else result,
                "duration_ms": step.duration_ms
            })
        
        # === 4. Final Validation ===
        await self._send_plan_event(PlanEventType.PLAN_VALIDATION, {
            "message": "éªŒè¯æ‰€æœ‰æ­¥éª¤å·²å®Œæˆ",
            "completed_steps": len(plan.steps),
            "failed_steps": 0,
            "success_rate": "100%"
        })
```

#### 4.3 å‰ç«¯ UI ç»„ä»¶ (React)
**æ–‡ä»¶**: `frontend/src/components/PlanProgress.tsx` (æ–°å»º)

```tsx
import React, { useState } from 'react';

interface PlanStep {
  step_number: number;
  step_name: string;
  tool: string;
  status: 'pending' | 'running' | 'complete' | 'failed';
  output_preview?: string;
}

export const PlanProgress: React.FC = () => {
  const [currentStage, setCurrentStage] = useState<'analyzing' | 'planning' | 'executing' | 'validating'>('analyzing');
  const [steps, setSteps] = useState<PlanStep[]>([]);
  const [progress, setProgress] = useState(0);
  const [message, setMessage] = useState('æ­£åœ¨åˆ†æä»»åŠ¡...');

  // WebSocket æ¶ˆæ¯å¤„ç†
  useEffect(() => {
    const ws = new WebSocket(WS_URL);
    
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      
      switch (data.type) {
        case 'plan_generation_start':
          setCurrentStage('analyzing');
          setMessage(data.data.message);
          break;
          
        case 'plan_generation_complete':
          setCurrentStage('planning');
          setMessage(`è®¡åˆ’å·²ç”Ÿæˆï¼š${data.data.plan_preview}`);
          break;
          
        case 'plan_step_start':
          setCurrentStage('executing');
          setSteps(prev => prev.map((step, i) => ({
            ...step,
            status: i === data.data.step_number - 1 ? 'running' : step.status
          })));
          setProgress(data.data.progress_percent);
          break;
          
        case 'plan_step_complete':
          setSteps(prev => prev.map((step, i) => ({
            ...step,
            status: i === data.data.step_number - 1 ? 'complete' : step.status,
            output_preview: data.data.output_preview
          })));
          break;
      }
    };
    
    return () => ws.close();
  }, []);

  return (
    <div className="plan-progress-container">
      {/* é˜¶æ®µæŒ‡ç¤ºå™¨ */}
      <div className="stage-indicator">
        <div className={`stage ${currentStage === 'analyzing' ? 'active' : ''}`}>
          ğŸ” åˆ†æ
        </div>
        <div className={`stage ${currentStage === 'planning' ? 'active' : ''}`}>
          ğŸ“‹ è§„åˆ’
        </div>
        <div className={`stage ${currentStage === 'executing' ? 'active' : ''}`}>
          âš¡ æ‰§è¡Œ
        </div>
        <div className={`stage ${currentStage === 'validating' ? 'active' : ''}`}>
          âœ… éªŒè¯
        </div>
      </div>
      
      {/* è¿›åº¦æ¡ */}
      <div className="progress-bar">
        <div 
          className="progress-fill" 
          style={{ width: `${progress}%` }}
        />
        <span className="progress-text">{progress}%</span>
      </div>
      
      {/* æ­¥éª¤åˆ—è¡¨ */}
      <div className="steps-list">
        {steps.map((step, index) => (
          <div key={index} className={`step-item step-${step.status}`}>
            <div className="step-icon">
              {step.status === 'running' && 'â³'}
              {step.status === 'complete' && 'âœ…'}
              {step.status === 'failed' && 'âŒ'}
              {step.status === 'pending' && 'â¸ï¸'}
            </div>
            <div className="step-info">
              <div className="step-name">{step.step_name}</div>
              <div className="step-tool">å·¥å…·ï¼š{step.tool}</div>
              {step.output_preview && (
                <div className="step-output">{step.output_preview}</div>
              )}
            </div>
          </div>
        ))}
      </div>
      
      {/* çŠ¶æ€æ¶ˆæ¯ */}
      <div className="status-message">
        {message}
      </div>
    </div>
  );
};
```

---

## ğŸ“Š éªŒæ”¶æ ‡å‡†

### Phase 1 éªŒæ”¶ (Plan è´¨é‡ä¼˜åŒ–)
- [ ] Plan æ­¥éª¤æ•°å‡å°‘ 20% (5 æ­¥ â†’ 4 æ­¥æˆ–æ›´å°‘)
- [ ] é›¶çº¯éªŒè¯æ­¥éª¤ï¼ˆYAGNI æ£€æŸ¥é€šè¿‡ï¼‰
- [ ] å·¥å…·æè¿°å‡†ç¡®ç‡ 100%ï¼ˆæ— è™šæ„å·¥å…·ï¼‰

### Phase 2 éªŒæ”¶ (å·¥å…·ç²¾å‡†è°ƒç”¨)
- [ ] è¯­ä¹‰æ˜ å°„è¡¨è¦†ç›–ç‡ 100%ï¼ˆæ‰€æœ‰è¯­ä¹‰æ ‡ç­¾éƒ½æœ‰ decompositionï¼‰
- [ ] æŠ€èƒ½å…ƒæ•°æ®è·å–æˆåŠŸç‡ >95%
- [ ] Tool/Skill åŒ¹é…å‡†ç¡®åº¦ >90%

### Phase 3 éªŒæ”¶ (æ—¥å¿—å¢å¼º)
- [ ] Plan è¯¦ç»†æ—¥å¿—è®°å½•ç‡ 100%
- [ ] æ¯æ¡ log åŒ…å« session_id, trace_id
- [ ] æ”¯æŒæŒ‰ trace_id å®Œæ•´å›æ”¾æ‰§è¡Œè¿‡ç¨‹

### Phase 4 éªŒæ”¶ (æµå¼åé¦ˆ)
- [ ] å‰ç«¯å®æ—¶æ˜¾ç¤º 4 ä¸ªé˜¶æ®µï¼ˆåˆ†æâ†’è§„åˆ’â†’æ‰§è¡Œâ†’éªŒè¯ï¼‰
- [ ] è¿›åº¦æ›´æ–°å»¶è¿Ÿ <500ms
- [ ] ç”¨æˆ·æ»¡æ„åº¦è¯„åˆ† >4.5/5

---

## ğŸ¯ å®æ–½é¡ºåºä¸ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | Phase | é¢„è®¡å·¥æ—¶ | ä¾èµ– |
|--------|-------|----------|------|
| **P0** | Phase 1: Plan è´¨é‡ä¼˜åŒ– | 4 å°æ—¶ | æ—  |
| **P0** | Phase 3: æ—¥å¿—å¢å¼º | 3 å°æ—¶ | Phase 1 |
| **P1** | Phase 2: å·¥å…·ç²¾å‡†åŒ– | 6 å°æ—¶ | Phase 1 |
| **P1** | Phase 4: æµå¼åé¦ˆ | 8 å°æ—¶ | Phase 2, 3 |

**æ€»è®¡**: 21 å°æ—¶ï¼ˆçº¦ 3 ä¸ªå·¥ä½œæ—¥ï¼‰

---

## ğŸ“ å…³é”®æ–‡ä»¶æ¸…å•

### ä¿®æ”¹æ–‡ä»¶
1. `src/orchestrator/light_planner.py` - Prompt é‡æ„
2. `src/orchestrator/structured_planner.py` - æŠ€èƒ½ç»‘å®šä¼˜åŒ–
3. `src/orchestrator/task_analyzer.py` - æŠ€èƒ½è·¯ç”±å¢å¼º
4. `src/orchestrator/engine.py` - æ—¥å¿—å¢å¼º + æµå¼äº‹ä»¶
5. `src/api/websocket.py` - äº‹ä»¶ç±»å‹æ‰©å±•

### æ–°å»ºæ–‡ä»¶
6. `src/tools/semantic_mapping.py` - å·¥å…·è¯­ä¹‰æ˜ å°„è¡¨
7. `frontend/src/components/PlanProgress.tsx` - æµå¼è¿›åº¦ç»„ä»¶
8. `frontend/src/types/plan.ts` - Plan ç±»å‹å®šä¹‰

---

## ğŸš€ é¢„æœŸæ•ˆæœ

### Before (å½“å‰)
```
ç”¨æˆ·ï¼š"ç”Ÿæˆ 2026 AI è¶‹åŠ¿æŠ¥å‘Š PDF"
â†’ Plan: 5 æ­¥ï¼ˆåŒ…å«è¿‡åº¦éªŒè¯ï¼‰
â†’ æ‰§è¡Œï¼šStep 5 åœæ» 3 æ¬¡ â†’ Replan
â†’ æ—¥å¿—ï¼šç®€å•ï¼Œç¼ºå°‘ç»†èŠ‚
â†’ ç”¨æˆ·ç•Œé¢ï¼šç­‰å¾…ï¼Œä¸çŸ¥é“è¿›å±•
```

### After (ä¼˜åŒ–å)
```
ç”¨æˆ·ï¼š"ç”Ÿæˆ 2026 AI è¶‹åŠ¿æŠ¥å‘Š PDF"
â†’ ğŸ” åˆ†æé˜¶æ®µ (0.5s): "æ£€æµ‹åˆ°å¤æ‚ä»»åŠ¡ï¼Œéœ€è¦è§„åˆ’"
â†’ ğŸ“‹ è§„åˆ’é˜¶æ®µ (2s): "ç”Ÿæˆ 3 æ­¥è®¡åˆ’"
   1. web_search: æœç´¢ä¿¡æ¯
   2. write_file: æ’°å†™æŠ¥å‘Š
   3. write_file + run_in_terminal: ç”Ÿæˆ PDF
â†’ âš¡ æ‰§è¡Œé˜¶æ®µ (æµå¼):
   Step 1/3: ğŸ” æœç´¢ä¸­... âœ… å®Œæˆ (2.1s)
   Step 2/3: âœï¸ æ’°å†™ä¸­... âœ… å®Œæˆ (1.5s)
   Step 3/3: ğŸ“„ ç”Ÿæˆ PDF... âœ… å®Œæˆ (3.2s)
â†’ âœ… éªŒè¯é˜¶æ®µ (0.3s): "æ‰€æœ‰æ­¥éª¤å®Œæˆï¼ŒPDF å·²ç”Ÿæˆ"
â†’ æ—¥å¿—ï¼šå®Œæ•´è®°å½•æ¯ä¸ªå†³ç­–ç‚¹
â†’ ç”¨æˆ·ä½“éªŒï¼šå®æ—¶å¯è§è¿›åº¦ï¼Œå®‰å¿ƒ
```

---

## ğŸ‰ æ€»ç»“

æœ¬æ–¹æ¡ˆé€šè¿‡**å››ä¸ª Phase**ç³»ç»Ÿæ€§è§£å†³ï¼š
1. **Plan è´¨é‡**: YAGNI åŸåˆ™ + æœ€çŸ­è·¯å¾„
2. **å·¥å…·ç²¾å‡†**: è¯­ä¹‰æ˜ å°„ + æŠ€èƒ½å…ƒæ•°æ®
3. **æ—¥å¿—å®Œæ•´**: è¯¦ç»†è®°å½• + å¯è¿½æº¯
4. **ä½“éªŒä¼˜åŒ–**: æµå¼åé¦ˆ + å®æ—¶è¿›åº¦

**æ ¸å¿ƒä»·å€¼**: è®©ç”¨æˆ·ä»"é»‘ç›’ç­‰å¾…"å˜ä¸º"é€æ˜å¯æ§"ï¼Œæå‡ä¿¡ä»»æ„Ÿå’Œæ»¡æ„åº¦ã€‚